<?php
    /*$xml = "79006200730068003900380063003800700066003200720072003700390052003100440078004E004500570038005800440058003400450041005A0068004A005300500035004800440037007A007000560058006C00590066006A006700520073007100620052004A0054002B00590046005600530076004C0050005000440041002B00470074007800700066007600520056006A004C005800380054005400410067004D005100760030006A006B00470057006D00770066002F007800720069006F006300660036005A0052007A006300770048002B0054007200710059006200420077004C00790046004A0050006C002F0062006100450031004900550043004900780065006F0074006B0056007A0067002F0045006F0041002B0034007800730048007900580070006E004500680072004F00390078003600710066006A0058007000580068006D0036006B007A0077006B006E00450073006600430046006A0057006A00510035005900370067006D003700750057002B007A002F004A0078004C00480077006800590031006F0030004F0057004F0034004A00750037006C00760073002F003900410058003200440053004700670068004E0066007200470057002F002B004E0039007900370045005500570031005600790036006D004E0075004D0068005600500057006C003400550044006F007800790044006E006C006E0052004C004A00570045005900410031004D0068003700450074003300340034006C00440067003D003D00";
    $_Data = mb_convert_encoding(@mcrypt_decrypt(MCRYPT_RIJNDAEL_128, "1234567890111213", base64_decode(hex2bin($xml)), MCRYPT_MODE_ECB, ""), "UTF-8", "Big5");
    //echo $_Data;
    $my_string = preg_replace(array('/\n/', '/\r/'), '#PH#', $_Data);
    $data_array = explode('#PH#', $my_string);
    var_dump($data_array);

    $_Account       = trim(substr($data_array[0], -34, 20));
    $_Date          = trim(substr($data_array[0], -8));
    $_Time          = trim(substr($data_array[0], -14, 6));
    echo $_Account ." > ". $_Date. " " . $_Time;*/

    $XmlFile = '<?xml version="1.0" encoding="big5"?><MYB2B><HEADER><TXNO>2021051115260445</TXNO><SecureFunc>1</SecureFunc></HEADER><BODY><DATA>79006200730068003900380063003800700066003200720072003700390052003100440078004E0045006300750055002B0071003300730050005900510055004C0077002B0074007A00340075003300310078007800590066006A006700520073007100620052004A0054002B00590046005600530076004C005000500044004100310031007A0070006200490045007600620073003200430030004C003700550074005500390030005600470073003200370057006C00460052006F004500720066006E00500058005A00690051004400520059003800660061003800450036006E00580048007700730038004A00460065003400330079006A006B0054006C00560077005600630031002F00650055006D0037004B0062005700390070006900380079004F00640069006300530078003800490057004E0061004E0044006C006A007500430062007500350062003700500038006E00450073006600430046006A0057006A00510035005900370067006D003700750057002B007A002F004A0078004C00480077006800590031006F0030004F0057004F0034004A00750037006C00760073002F0032006F00350033006E0052005200780047004400610050004F005100500068003800590062006F007900660052004D004E006E004A00700038006F002F0061002F004300470059002B00690075004700790047003200630043004C0070004F004D0078003100520053004100350067004800770068004B00650057006A0039006B004200440052003600300044006100420064002B004C00550050004F00790039003500570055006800700058006700570051006700780036004F004F00420073004A0075006E00440071004E0055004C006800770036004F00390043006E0065006C0076004E004C0067007300640033004500700056004B0038004A006A00370046004B00490039006D00660030006D007500680033004900320072004800470037006B00500073002F0049006B0049002F00370050005800680058006F006F00760044004500590044005400680064003500560066002F002F005100760050004D0063006C005700300065004700430043004A0063004B002F005A0034006C00690062003500500045006C006F0038004F0053004D0076002B00380030006900590054007200750038006E00450073006600430046006A0057006A00510035005900370067006D003700750057002B007A002F004A0078004C00480077006800590031006F0030004F0057004F0034004A00750037006C00760073002F0079006300530078003800490057004E0061004E0044006C006A00750043006200750035006200370050002F00760076005200310070006F00550079002F004F0051005400540049004F00620068006D00670063002F004B004D00470079002F00590047006B004600730055006B002F007A0041005A006500420072003000390074004D0049004300420057002B005A00540064007300460058007600490066003000700065002F004A0034003D00</DATA></BODY></MYB2B>
';
    $xml = simplexml_load_string($XmlFile);
    $_Data = mb_convert_encoding(@mcrypt_decrypt(MCRYPT_RIJNDAEL_128, "1234567890111213", base64_decode(hex2bin($xml->BODY->DATA)), MCRYPT_MODE_ECB, ""), "UTF-8", "Big5");
    //echo $_Data;
    $my_string = preg_replace(array('/\n/', '/\r/'), '#PH#', $_Data);
    $data_array = explode('#PH#', $my_string);
    var_dump($data_array);

    /*$_Account       = trim(substr($data_array[0], -34, 20));
    $_Date          = trim(substr($data_array[0], -8));
    $_Time          = trim(substr($data_array[0], -14, 6));
    echo $_Account ." > ". $_Date. " " . $_Time;*/
    $data_array = array_filter($data_array);
	$key = array_keys($data_array);
	$size = sizeOf($key);
    var_dump($data_array);
    for ($i=0; $i < $size; $i++) {

        if (strlen($data_array[$key[$i]]) > 20) {
            $_OrderID       = trim(mb_substr($data_array[$key[$i]], 18, 9, "utf-8"));
            $_Amount        = intval(mb_substr($data_array[$key[$i]], 39, 13, "utf-8"));
            $_VirAccount    = mb_substr($data_array[$key[$i]], 68, 14, "utf-8");
            $_BankCode      = trim(mb_substr($data_array[$key[$i]], 97, 7, "utf-8"));
            $_Account       = trim(substr($data_array[$key[$i]], -34, 20));
            $_Date          = trim(substr($data_array[$key[$i]], -8));
            $_Time          = trim(substr($data_array[$key[$i]], -14, 6));
            $_PaymentDate = Date('Y-m-d H:i:s', strtotime($_Date.$_Time));
            
            var_dump($_OrderID."|".$_Amount."|".$_VirAccount."|".$_BankCode."|".$_Account."|".$_Date."|".$_Time."|".$_PaymentDate);
        }
    }
?>